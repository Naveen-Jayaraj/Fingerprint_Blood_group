<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fingerprint Scryer âœ§ Soul Essence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <!-- Import Cormorant Garamond font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Set initial theme based on localStorage or system preference
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        html, body {
            height: 100%; /* Ensure html and body take full height */
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Cormorant Garamond', serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 1.1rem;
        }
        /* Light Theme Variables */
        :root {
            --bg-primary: #fdfbf6;
            --bg-secondary: #fffefb;
            --text-primary: #3a2e20;
            --text-secondary: #857663;
            --accent-primary: #a08c6d;
            --accent-secondary: #f3eee8;
            --border-color: #e0d8cc;
            --border-dashed: #d1c6b8;
            --shadow-color: rgba(140, 109, 70, 0.05);
            --nav-bg: rgba(253, 251, 246, 0.85);
            --button-text: #fdfbf6;
        }
        /* Dark Theme Variables */
        .dark {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --text-primary: #e0d8cc;
            --text-secondary: #a09383;
            --accent-primary: #e0d8cc;
            --accent-secondary: #1a1a1a;
            --border-color: #333333;
            --border-dashed: #555555;
            --shadow-color: rgba(224, 216, 204, 0.05);
            --nav-bg: rgba(10, 10, 10, 0.85);
            --button-text: #0a0a0a;
        }

        /* General page layout */
        .page-container {
             padding: 5rem 1.5rem 1.5rem 1.5rem;
             box-sizing: border-box;
             width: 100%;
             @media (min-width: 768px) {
                 padding-left: 3rem;
                 padding-right: 3rem;
             }
             @media (min-width: 1024px) {
                 padding-left: 5rem;
                 padding-right: 5rem;
             }
        }
         .content-wrapper {
             width: 100%;
             margin: 0 auto;
         }

        .content-section {
            background-color: var(--bg-secondary);
            border-radius: 0.375rem;
            padding: 2rem;
            border: 1px solid var(--border-color);
            margin-bottom: 2.5rem;
            box-shadow: 0 1px 3px 0 var(--shadow-color);
             width: 100%;
             box-sizing: border-box;
             @media (min-width: 640px) {
                 padding: 3rem;
             }
        }
         .dark .content-section {
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-color);
         }
         .content-section:last-of-type {
            margin-bottom: 0;
         }

        /* Full Height Section Styling */
        .full-height-section {
            min-height: calc(100vh - 5rem);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding-top: 2rem;
            padding-bottom: 2rem;
            box-sizing: border-box;
            width: 100%;
        }

        /* Navbar Styles */
        nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
            background-color: var(--nav-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            padding: 0.85rem 1.5rem; height: 5rem;
             box-sizing: border-box;
             @media (min-width: 768px) {
                 padding-left: 3rem;
                 padding-right: 3rem;
             }
              @media (min-width: 1024px) {
                 padding-left: 5rem;
                 padding-right: 5rem;
             }
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .navbar-content {
             margin: 0 auto; display: flex; justify-content: space-between; align-items: center; height: 100%;
        }
        .navbar-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; }

        #howItWorksGrid {
            position: relative;
            grid-template-columns: repeat(1, minmax(0, 1fr));
             @media (min-width: 640px) {
                 grid-template-columns: repeat(2, minmax(0, 1fr));
             }
              @media (min-width: 1024px) {
                 grid-template-columns: repeat(3, minmax(0, 1fr));
             }
        }

        .file-upload-wrapper {
            border: 1px dashed var(--border-dashed); background-color: transparent; color: var(--text-secondary);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            cursor: pointer; padding: 3rem; text-align: center; border-radius: 0.375rem;
            max-width: 400px; margin-left: auto; margin-right: auto; width: 90%;
        }
        .file-upload-wrapper:hover { border-color: var(--accent-primary); background-color: var(--accent-secondary); color: var(--text-primary); }
         .dark .file-upload-wrapper:hover { background-color: var(--bg-secondary); }
        input[type="file"] { display: none; }
        .file-upload-text { font-size: 1rem; }

        button {
            background-color: var(--accent-primary); color: var(--button-text);
            transition: background-color 0.3s ease, transform 0.1s ease, color 0.3s ease;
            padding: 0.75rem 1.5rem; border-radius: 0.25rem;
            font-weight: 500; display: inline-flex;
            align-items: center; justify-content: center;
            border: 1px solid transparent; font-size: 1.1rem;
        }
        .dark #goToPredictorBtn {
            background-color: transparent; color: var(--accent-primary); border: 1px solid var(--accent-primary);
        }
        .dark #goToPredictorBtn:hover { background-color: var(--accent-secondary); filter: none; }
        .dark #predictButton { background-color: var(--accent-primary); color: var(--button-text); border: 1px solid transparent; }
        .dark #predictButton:hover { filter: brightness(115%); }

        #themeToggle, #backToHomeBtn { background-color: transparent; padding: 0.5rem; border: none; }
        #backToHomeBtn { color: var(--text-secondary); font-size: 1rem; }
        #backToHomeBtn:hover { background-color: var(--accent-secondary); color: var(--accent-primary); }
        .dark #themeToggle, .dark #backToHomeBtn { color: var(--text-secondary); background-color: transparent; }
        .dark #themeToggle:hover, .dark #backToHomeBtn:hover { background-color: var(--accent-secondary); color: var(--accent-primary); }

        button:hover { filter: brightness(115%); }
        button:active { transform: translateY(1px); }
        button:disabled {
            filter: grayscale(80%); opacity: 0.4; cursor: not-allowed;
            background-color: var(--accent-secondary) !important; color: var(--text-secondary) !important;
            border-color: var(--border-color) !important;
        }
         .dark button:disabled { background-color: var(--accent-secondary) !important; color: var(--text-secondary) !important; border-color: var(--border-color) !important; }

        #result span {
            display: inline-block; background-color: var(--accent-secondary); color: var(--accent-primary);
            border: 1px solid var(--border-color); padding: 0.6rem 1.8rem;
            border-radius: 0.25rem; font-weight: 600; font-size: 1.4rem;
        }
         .dark #result span { background-color: var(--accent-secondary); border: 1px solid var(--border-color); color: var(--text-primary); }

        #messageBox { font-size: 1rem; border-radius: 0.375rem; max-width: 400px; margin: 1rem auto 0 auto; width: 90%; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        .dark .error { background-color: #2c1a1d; color: #f8d7da; border-color: #721c24;}
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        .dark .success { background-color: #1a301d; color: #d4edda; border-color: #155724;}
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}
        .dark .info { background-color: #1a2f33; color: #d1ecf1; border-color: #0c5460;}

        .loader { width: 16px; height: 16px; border: 2px solid currentColor; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; margin-left: 10px; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Smooth theme transition */
        html, body, nav, .content-section, .about-card, input, button, #result span, .file-upload-wrapper, label, h1, h2, h3, p, a, svg, summary, span {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, fill 0.3s ease, box-shadow 0.3s ease;
        }
        .about-section {
             margin-bottom: 0 !important;
             padding-top: 4rem;
             padding-bottom: 4rem;
        }

        .about-section h2 { font-size: 1.6rem; font-weight: 600; margin-bottom: 2rem; color: var(--text-primary); text-align: center; }
        .about-card {
            background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.375rem;
            padding: 1.5rem; box-shadow: 0 1px 3px 0 var(--shadow-color); cursor: grab;
            user-select: none; position: relative; transition: transform 0.2s ease, box-shadow 0.2s ease; left: auto; top: auto;
        }
        .dark .about-card { background-color: var(--bg-secondary); }
        .about-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px -1px var(--shadow-color); }
        .about-card h3 { font-size: 1.15rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.6rem; }
         .dark .about-card h3 { color: var(--text-primary); }
        .about-card p { color: var(--text-secondary); font-size: 1rem; line-height: 1.6; }
        .about-card code {
            background-color: var(--accent-secondary); padding: 0.1rem 0.3rem; border-radius: 0.25rem;
            font-size: 0.85em; color: var(--accent-primary); font-family: 'Courier New', Courier, monospace; /* Classic monospace */
        }
        .dark .about-card code { color: var(--text-primary); background-color: var(--accent-secondary); }

        .dragging {
            position: absolute; cursor: grabbing; opacity: 0.85; z-index: 1000;
            box-shadow: 0 8px 16px -2px rgba(0,0,0,0.15);
             transition: none; transform: scale(1.01);
        }
        .dragging:hover { transform: scale(1.01); box-shadow: 0 8px 16px -2px rgba(0,0,0,0.15); }
        .dark .dragging, .dark .dragging:hover { box-shadow: 0 8px 16px -2px rgba(224, 216, 204, 0.1); }

        .github-button svg { fill: currentColor; }
        .header-icon { color: var(--text-secondary); }
        .header-icon:hover { color: var(--accent-primary); }

        /* Home Page specific styles */
        #homePage { text-align: center; max-width: 52rem; margin: 0 auto; }
        #homePage h1.title { font-size: 3.2rem; font-weight: 600; margin-bottom: 2rem; }
        #homePage h1.emoji { font-size: 3.5rem; margin-bottom: 0.75rem; }
        #homePage p { font-size: 1.2rem; margin-bottom: 3rem; color: var(--text-secondary); max-width: 90%; margin-left: auto; margin-right: auto; }
        #goToPredictorBtn { font-size: 1.1rem; padding: 0.85rem 1.8rem; }

        /* Footer */
        footer {
            text-align: center; font-size: 0.9rem; color: var(--text-secondary);
            padding: 3rem 1.5rem 1.5rem 1.5rem;
            width: 100%; box-sizing: border-box;
            background-color: var(--bg-primary);
             @media (min-width: 768px) {
                 padding-left: 3rem;
                 padding-right: 3rem;
             }
              @media (min-width: 1024px) {
                 padding-left: 5rem;
                 padding-right: 5rem;
             }
        }
        footer a { color: var(--text-secondary); }
        footer a:hover { color: var(--accent-primary); }
        footer .love { font-size: 0.8rem; margin-top: 0.25rem; } /* Style for "made with love" */

        /* Hide/Show Views */
        .view { display: none; }
        .view.active { display: block; }

        #howItWorksGrid { min-height: 200px; }

         /* Prediction section specific content centering */
        #predictionSection > div {
            width: 100%;
            max-width: 40rem;
            margin-left: auto;
            margin-right: auto;
            padding-left: 1rem;
            padding-right: 1rem;
        }

    </style>
</head>
<body class="bg-[--bg-primary] text-[--text-primary]">

    <!-- Navbar -->
    <nav>
        <div class="navbar-content">
             <div id="navLeft" class="flex items-center">
                <button id="backToHomeBtn" class="p-2 rounded-md hover:bg-[--accent-secondary] text-sm text-[--text-secondary] hover:text-[--accent-primary] mr-3 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <span class="navbar-title">The Fingerprint Scryer âœ§</span> <!-- Updated Title -->
             </div>
             <button id="themeToggle" aria-label="Toggle dark mode" class="p-2 rounded-md hover:bg-[--accent-secondary]">
                 <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 header-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 18a6 6 0 100-12 6 6 0 000 12z" />
                 </svg>
                  <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 header-icon hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                  </svg>
             </button>
        </div>
    </nav>

    <div class="page-container">
        <div class="content-wrapper">

            <!-- Home Page View -->
            <div id="homePage" class="view active content-section full-height-section">
                 <div>
                     <h1 class="emoji text-[--text-primary]">âœ§</h1> <!-- Updated Emoji -->
                     <h1 class="title text-[--text-primary]">Behold, the Fingerprint Scryer</h1> <!-- Updated Title -->
                     <p>
                         Unveil the hidden truths held within thy hand's mark. Present forth an image of thy fingerprint, and allow this enchanted artefact to divine the nature of thy soul's essence, safely held within the confines of thine own browser-glass.
                     </p> <!-- Updated Paragraph -->
                     <button id="goToPredictorBtn">
                         Consult the Scryer <!-- Updated Button Text -->
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                         </svg>
                     </button>
                 </div>
            </div>

            <!-- Predictor Page View -->
            <div id="predictorPage" class="view">

                <!-- Prediction Section - Full height -->
                <div id="predictionSection" class="content-section full-height-section space-y-6">
                    <div>
                        <label for="imageFile" class="text-base font-medium text-[--text-secondary] mb-3 block">Offer Thy Hand's Mark:</label> <!-- Updated Label -->
                        <label for="imageFile" class="file-upload-wrapper block rounded-md p-6 text-center">
                             <span class="file-upload-text block text-sm font-medium" id="fileUploadText">
                                 Click hither or bestow image upon this place
                             </span> <!-- Updated Dropzone Text -->
                             <input type="file" id="imageFile" accept="image/*" required>
                         </label>
                        <img id="imagePreview" src="#" alt="Preview" class="w-24 h-24 object-cover mx-auto rounded-md border border-[--border-color] bg-[--bg-primary] hidden mt-4"/>
                        <button id="predictButton" disabled class="w-full max-w-xs mx-auto justify-center mt-5 py-3 text-lg">
                             Divine Essence <!-- Updated Button Text -->
                             <span id="loader" class="loader hidden"></span>
                        </button>
                        <div id="messageBox" class="hidden mt-5 p-3 rounded-md text-base"></div>
                        <div id="result" class="mt-6 text-center text-xl font-medium text-[--text-primary]"></div>
                    </div>
                </div>

                <!-- How It Works Section - Regular flow -->
                <div id="aboutSection" class="content-section about-section">
                    <h2 class="text-xl font-semibold text-[--text-primary] mb-6">The Artefact's Craft (Drag Scrolls)</h2> <!-- Updated Title -->
                    <div id="howItWorksGrid" class="grid gap-5">
                        <!-- Cards -->
                        <div class="about-card draggable" id="card-1">
                            <h3>1. Ancient Lore</h3> <!-- Updated -->
                            <p>Tutored upon Kaggle's scrolls of "Finger Prints and Lifeblood Signs" (<code>A+</code>, <code>B-</code>...).</p> <!-- Updated -->
                        </div>
                         <div class="about-card draggable" id="card-2">
                            <h3>2. Crystal Matrix</h3> <!-- Updated -->
                            <p>Wrought with TensorFlow/Keras enchantments (<code>Conv2D</code>, <code>MaxPool</code>, <code>Dropout</code>, <code>Dense</code>).</p> <!-- Updated -->
                        </div>
                         <div class="about-card draggable" id="card-3">
                            <h3>3. Mark Scrutiny</h3> <!-- Updated -->
                            <p>Imprints resized to <code>64x64px</code> & essence refined (0-1).</p> <!-- Updated -->
                        </div>
                         <div class="about-card draggable" id="card-4">
                            <h3>4. Attunement</h3> <!-- Updated -->
                            <p>Imbued via Adam's Method & crossentropy rite (<code>.h5</code> sealed).</p> <!-- Updated -->
                        </div>
                         <div class="about-card draggable" id="card-5">
                            <h3>5. Ã†ther Weaving</h3> <!-- Updated -->
                            <p><code>.h5</code> seal transmuted to TensorFlow.js runes.</p> <!-- Updated -->
                        </div>
                         <div class="about-card draggable" id="card-6">
                            <h3>6. Scrying Mirror</h3> <!-- Updated -->
                            <p>HTML/CSS/JS portal. TensorFlow.js scries within thy browser.</p> <!-- Updated -->
                         </div>
                    </div>
                </div>
            </div> <!-- End Predictor Page View -->

             <!-- Footer -->
             <footer class="w-full">
                <p>Crafted by Naveen Jayaraj</p> <!-- Updated -->
                <a href="https://github.com/Naveen-Jayaraj/Fingerprint_Blood_group" target="_blank" rel="noopener noreferrer" class="github-button inline-flex items-center space-x-1 mt-1"> <!-- Updated -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8"/>
                    </svg>
                    <span>View Scroll on GitHub</span> <!-- Updated -->
                 </a>
                 <p class="mt-1">Seek Audience: <a href="https://naveen-jayaraj.github.io/Portfolio_Website" target="_blank" rel="noopener noreferrer">Portfolio Portal</a></p> <!-- Updated -->
                 <p class="love">~ Made with arcane arts & love ~</p> <!-- Added -->
             </footer>

        </div> <!-- End Content Wrapper -->
    </div> <!-- End Page Container -->

    <!-- Offscreen canvas for processing -->
    <canvas id="offscreenCanvas" width="64" height="64" style="display:none;"></canvas>

    <script>
        // --- DOM Elements ---
        const imageFileInput = document.getElementById('imageFile');
        const predictButton = document.getElementById('predictButton');
        const imagePreview = document.getElementById('imagePreview');
        const resultDiv = document.getElementById('result');
        const messageBox = document.getElementById('messageBox');
        const loader = document.getElementById('loader');
        const fileUploadText = document.getElementById('fileUploadText');
        const offscreenCanvas = document.getElementById('offscreenCanvas');
        const ctx = offscreenCanvas.getContext('2d');
        const themeToggleButton = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const htmlElement = document.documentElement;
        const howItWorksGrid = document.getElementById('howItWorksGrid');
        const homePageView = document.getElementById('homePage');
        const predictorPageView = document.getElementById('predictorPage');
        const goToPredictorBtn = document.getElementById('goToPredictorBtn');
        const backToHomeBtn = document.getElementById('backToHomeBtn');


        // --- State ---
        let model = null;
        let imageFile = null;
        let modelLoaded = false;
        const modelPath = './tfjs_model/model.json';
        const CLASS_NAMES = ['A+', 'A-', 'AB+', 'AB-', 'B+', 'B-', 'O+', 'O-'];
        const IMG_SIZE = 64;

        // --- Draggable Card State ---
        let draggedCard = null;
        let isDragging = false;
        let currentX, currentY, targetX, targetY;
        let animationFrameId = null;
        const dampingFactor = 0.2;
        let cardStartX, cardStartY;
        let mouseStartX, mouseStartY;

        // --- View Navigation ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            const viewToShow = document.getElementById(viewId);
            if (viewToShow) {
                viewToShow.classList.add('active');
            }
            if (viewId === 'predictorPage') {
                backToHomeBtn.classList.remove('hidden');
                 document.body.style.overflowY = 'auto'; // Ensure scroll
                 window.scrollTo(0, 0); // Scroll to top
            } else {
                backToHomeBtn.classList.add('hidden');
                document.body.style.overflowY = 'auto';
            }
            if (viewId === 'predictorPage' && !modelLoaded) {
                 loadModel();
                 initializeDraggableCards();
                 modelLoaded = true;
            }
        }

        goToPredictorBtn.addEventListener('click', () => showView('predictorPage'));
        backToHomeBtn.addEventListener('click', () => showView('homePage'));

        // --- Theme Toggle Logic ---
        function applyTheme(isDark) {
            if (isDark) {
                htmlElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                htmlElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }
        themeToggleButton.addEventListener('click', () => {
            const isDarkMode = htmlElement.classList.toggle('dark');
            localStorage.theme = isDarkMode ? 'dark' : 'light';
            applyTheme(isDarkMode);
        });
        applyTheme(localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches));


        // --- File Handling ---
        function handleImageFile(event) {
            imageFile = null;
            const file = event.target.files[0];
            if (file) {
                imageFile = file;
                fileUploadText.textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                     showMessage('Mark received.', 'info'); // Updated
                }
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
                imagePreview.src = '#';
                fileUploadText.textContent = "Click hither or bestow image upon this place"; // Updated
                 showMessage('Pray, select an image file.', 'error'); // Updated
            }
             checkEnableButton();
        }
        function checkEnableButton() {
            if (predictButton) {
                predictButton.disabled = !(model && imageFile);
                if (!(model && imageFile) && resultDiv) {
                    resultDiv.textContent = '';
                }
            }
        }
        if (imageFileInput) { imageFileInput.addEventListener('change', handleImageFile); }
        if (predictButton) { predictButton.addEventListener('click', predict); }

        // --- TensorFlow.js Logic ---
        async function loadModel() {
            setLoading(true, 'Awakening the Artefact...'); // Updated
            try {
                model = await tf.loadLayersModel(modelPath);
                showMessage('The Scryer awaits. Offer thy mark.', 'success'); // Updated
                checkEnableButton();
            } catch (error) {
                console.error("Error loading model:", error);
                showMessage(`Scryer fails to awaken. Consult the console scrolls.`, 'error'); // Updated
                model = null;
                checkEnableButton();
            } finally {
                setLoading(false);
            }
        }
       async function preprocessImage(imgFile) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            const tensor = tf.browser.fromPixels(img)
                                .resizeBilinear([IMG_SIZE, IMG_SIZE])
                                .toFloat()
                                .div(tf.scalar(255.0))
                                .expandDims();
                            resolve(tensor);
                        } catch (preprocessError) {
                            reject(new Error(`Image transmutation failed.`)); // Updated
                        }
                    };
                    img.onerror = (err) => reject(new Error("Image fails to appear.")); // Updated
                    img.src = event.target.result;
                };
                reader.onerror = (err) => reject(new Error("Scroll read error.")); // Updated
                reader.readAsDataURL(imgFile);
            });
        }
        async function predict() {
            if (!model || !imageFile) {
                showMessage('Pray, offer an image.', 'error'); // Updated
                return;
            }
            setLoading(true, 'Scrying...'); // Updated
            if (resultDiv) resultDiv.innerHTML = '';
            let tensor;
            try {
                tensor = await preprocessImage(imageFile);
                const predictionTensor = model.predict(tensor);
                const predictedIndex = tf.argMax(predictionTensor, 1).dataSync()[0];
                const predictedClass = CLASS_NAMES[predictedIndex];
                if (resultDiv) resultDiv.innerHTML = `Essence Divined: <span>${predictedClass}</span>`; // Updated
                showMessage('The vision is clear!', 'success'); // Updated
                predictionTensor.dispose();
            } catch (error) {
                console.error("Prediction error:", error);
                showMessage(`Scrying failed: ${error.message}`, 'error'); // Updated
            } finally {
                if (tensor) tensor.dispose();
                setLoading(false);
            }
        }

        // --- UI Helpers ---
        function setLoading(isLoading, message = '') {
            const currentLoader = document.getElementById('loader');
            const currentPredictButton = document.getElementById('predictButton');
            if (isLoading) {
                 if (currentPredictButton) currentPredictButton.disabled = true;
                 if (currentLoader) currentLoader.classList.remove('hidden');
                 showMessage(message, 'info');
            } else {
                 if (currentLoader) currentLoader.classList.add('hidden');
                 checkEnableButton();
            }
        }
        function showMessage(message, type = 'info') {
             const currentMessageBox = document.getElementById('messageBox');
             if (currentMessageBox) {
                currentMessageBox.textContent = message;
                currentMessageBox.className = `messageBox mt-5 p-3 rounded-md text-base ${type}`;
                currentMessageBox.classList.remove('hidden');
             }
        }

        // --- Drag and Drop (Image Upload) ---
         const fileUploadWrapper = document.querySelector('.file-upload-wrapper');
         if (fileUploadWrapper) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileUploadWrapper.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            ['dragenter', 'dragover'].forEach(eventName => {
                fileUploadWrapper.addEventListener(eventName, () => fileUploadWrapper.classList.add('border-[--accent-primary]', 'bg-opacity-75', 'dark:bg-opacity-25'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                fileUploadWrapper.addEventListener(eventName, () => fileUploadWrapper.classList.remove('border-[--accent-primary]', 'bg-opacity-75', 'dark:bg-opacity-25'), false);
            });
            fileUploadWrapper.addEventListener('drop', handleDrop, false);
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0 && imageFileInput) {
                    imageFileInput.files = files;
                    const changeEvent = new Event('change');
                    imageFileInput.dispatchEvent(changeEvent);
                }
            }
         }

        // --- Draggable Cards Logic ---
        function initializeDraggableCards() {
            if (!howItWorksGrid) return;
            const draggableCards = howItWorksGrid.querySelectorAll('.draggable');
            draggableCards.forEach(card => {
                card.addEventListener('mousedown', startDrag);
                card.addEventListener('dragstart', (e) => e.preventDefault());
            });
        }
        function startDrag(e) { /* ... (JS for dragging - unchanged) ... */
            if (e.button !== 0 || isDragging) return;
            draggedCard = e.currentTarget; isDragging = true;
            const cardRect = draggedCard.getBoundingClientRect();
            const gridRect = howItWorksGrid.getBoundingClientRect();
            cardStartX = cardRect.left - gridRect.left; cardStartY = cardRect.top - gridRect.top;
            mouseStartX = e.pageX; mouseStartY = e.pageY;
            targetX = e.clientX - gridRect.left - (cardRect.width / 2);
            targetY = e.clientY - gridRect.top - (cardRect.height / 2);
            draggedCard.style.position = 'absolute'; draggedCard.style.left = `${targetX}px`;
            draggedCard.style.top = `${targetY}px`; draggedCard.style.width = `${cardRect.width}px`;
            draggedCard.classList.add('dragging');
            currentX = targetX; currentY = targetY;
            document.addEventListener('mousemove', dragMove); document.addEventListener('mouseup', endDrag);
            document.addEventListener('mouseleave', endDrag);
            cancelAnimationFrame(animationFrameId); animationFrameId = requestAnimationFrame(updatePositionLoop);
        }
        function dragMove(e) { /* ... (JS for dragging - unchanged) ... */
            if (!isDragging || !draggedCard) return; preventDefaults(e);
            const gridRect = howItWorksGrid.getBoundingClientRect();
            const cardRect = draggedCard.getBoundingClientRect();
            targetX = e.clientX - gridRect.left - (cardRect.width / 2);
            targetY = e.clientY - gridRect.top - (cardRect.height / 2);
        }
        function updatePositionLoop() { /* ... (JS for dragging - unchanged) ... */
            if (!isDragging || !draggedCard) return;
            const dx = targetX - currentX; const dy = targetY - currentY;
            currentX += dx * dampingFactor; currentY += dy * dampingFactor;
            draggedCard.style.left = `${currentX}px`; draggedCard.style.top = `${currentY}px`;
            animationFrameId = requestAnimationFrame(updatePositionLoop);
        }
        function endDrag(e) { /* ... (JS for dragging - unchanged) ... */
            if (!isDragging || !draggedCard) return; isDragging = false;
            cancelAnimationFrame(animationFrameId); draggedCard.classList.remove('dragging');
            draggedCard.style.width = ''; draggedCard.style.position = 'relative';
            draggedCard.style.left = 'auto'; draggedCard.style.top = 'auto';
            draggedCard = null; document.removeEventListener('mousemove', dragMove);
            document.removeEventListener('mouseup', endDrag); document.removeEventListener('mouseleave', endDrag);
        }

        // Initialize view state on load
        showView('homePage');

    </script>
</body>
</html>

